generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  mentor
  kadiv
  intern
}

enum InternshipStatus {
  aktif
  selesai
  diberhentikan
}

enum PermissionType {
  sakit
  izin
}

enum PermissionStatus {
  pending
  approved
  rejected
}

enum PresensiStatus {
  hadir
  izin
  alfa
  terlambat
}

enum LogbookStatus {
  draft
  sent
  review_mentor
  review_kadiv
  approved
  rejected
}

model Users {
  id_users           String    @id @default(uuid())
  full_name          String    @db.VarChar(100)
  email              String    @unique @db.VarChar(100)
  password           String    @db.VarChar(255)
  role               UserRole
  position           String?   @db.VarChar(100)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  
  // Security fields for account lockout
  failed_login_count Int       @default(0)
  locked_until       DateTime?
  last_failed_login  DateTime?

  internships          Internships[]
  approved_permissions Permissions[] @relation("PermissionApprover")
  approved_logbooks    Logbooks[]    @relation("LogbookApprover")

  @@map("users")
}

model Internships {
  id_internships String   @id @default(uuid())
  id_users       String
  start_date     DateTime @db.Date
  end_date       DateTime @db.Date
  status         InternshipStatus

  user        Users        @relation(fields: [id_users], references: [id_users], onDelete: Cascade)
  presensi    Presensi[]
  permissions Permissions[]
  logbooks    Logbooks[]

  @@map("internships")
}

model Permissions {
  id_permissions String           @id @default(uuid())
  id_internships String
  type           PermissionType
  title          String           @db.VarChar(150)
  reason         String?          @db.Text
  start_date     DateTime         @db.Date
  end_date       DateTime         @db.Date
  status         PermissionStatus @default(pending)
  approved_by    String?
  approved_at    DateTime?

  internship Internships @relation(fields: [id_internships], references: [id_internships], onDelete: Cascade)
  approver   Users?      @relation("PermissionApprover", fields: [approved_by], references: [id_users], onDelete: SetNull)
  presensi   Presensi[]

  @@map("permissions")
}

model Presensi {
  id_presensi          String         @id @default(uuid())
  id_internships       String
  id_permission        String?
  date                 DateTime       @db.Date
  check_in             DateTime?      @db.Time
  check_out            DateTime?      @db.Time
  checkin_latitude     Decimal?       @db.Decimal(10, 8)
  checkin_longitude    Decimal?       @db.Decimal(11, 8)
  checkin_location     String?        @db.VarChar(255)
  checkin_image_url    String?        @db.Text
  checkout_latitude    Decimal?       @db.Decimal(10, 8)
  checkout_longitude   Decimal?       @db.Decimal(11, 8)
  checkout_location    String?        @db.VarChar(255)
  checkout_image_url   String?        @db.Text
  status               PresensiStatus

  internship Internships  @relation(fields: [id_internships], references: [id_internships], onDelete: Cascade)
  permission Permissions? @relation(fields: [id_permission], references: [id_permissions], onDelete: SetNull)

  @@map("presensi")
}

model Logbooks {
  id_logbooks     String        @id @default(uuid())
  id_internships  String
  date            DateTime      @db.Date
  activity_detail String        @db.Text
  result_output   String?       @db.Text
  status          LogbookStatus @default(draft)
  approved_by     String?
  approved_at     DateTime?

  internship Internships @relation(fields: [id_internships], references: [id_internships], onDelete: Cascade)
  approver   Users?      @relation("LogbookApprover", fields: [approved_by], references: [id_users], onDelete: SetNull)

  @@map("logbooks")
}
